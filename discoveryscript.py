#!/usr/bin/python3

#############################################################################################################################
# author: sKillseries
# Ce script permet d'automatiser la phase découverte d'hôte et a pour but d'améliorer mes méthodologies en termes de pentest
#############################################################################################################################

import os

def save_result(command, output_file):
    os.system(f"{command} > {output_file}")
    print(f"Le résultat a été enregistré dans le fichier {output_file} situé dans le répertoire {enterprise}\n")

def discoveringhosts():
    print("Attention, il s'agit d'une découverte d'hôtes active et non passive !")
    print("""
Quelle méthode ou outil voulez-vous utiliser ?
> 1: ARP discovery
> 2: NBT discovery
> 3: IPv6
    """)
    choix = input("Veuillez sélectionner une option: ")
    if choix == "1":
        print("""
Quel outil voulez-vous utiliser ?
> 1: nmap
> 2: netdiscover
        """)
        option = input("Veuillez sélectionner l'outil désiré: ")
        if option == "1":
            save_result(f"nmap -sn {target}", f"{enterprise}/discoveringhosts.txt")
        elif option == "2":
            save_result(f"netdiscover -r {target}", f"{enterprise}/discoveringhosts.txt")
        else:
            print("Je n'ai pas compris votre choix, veuillez sélectionner l'une des options.")
            discoveringhosts()
    elif choix == "2":
        save_result(f"nbtscan -r {target}/{cidr}", f"{enterprise}/discoveringhosts.txt")
    elif choix == "3":
        iface = input("Veuillez saisir l'IFACE: ")
        save_result(f"alive6 {iface}", f"{enterprise}/discoveringhosts.txt")
    else:
        print("Je n'ai pas compris votre choix, veuillez sélectionner l'une des options.")
        discoveringhosts()

    proceed()

def sctpportdiscovery():
    save_result(f"nmap -T4 -sY -n --open -Pn {target}/{cidr}", f"{enterprise}/sctpportdiscovery.txt")
    proceed()

def udpportdiscovery():
    save_result(f"nmap -sU -sV --version-intensity 0 -F -n {target}/{cidr}", f"{enterprise}/udpportdiscovery.txt")
    proceed()

def httpportdiscovery():
    save_result(f"masscan -p80,443,8000-8100,8443,8080 {target}/{cidr}", f"{enterprise}/httpportdiscovery.txt")
    proceed()

def tcpportdiscovery():
    save_result(f"masscan -p20,21-23,25,53,80,110,111,135,139,143,443,445,993,995,1723,3306,3389,5900,8080 {target}/{cidr}",
                f"{enterprise}/tcpportdiscovery.txt")
    proceed()

def icmp():
    choix = input("Veuillez sélectionner une option: ")
    if choix == "1":
        save_result(f"fping -g {target}/{cidr}", f"{enterprise}/icmp.txt")
    elif choix == "2":
        save_result(f"nmap -PEPM -sP -vvv -n {target}/{cidr}", f"{enterprise}/icmp.txt")
    elif choix.lower() == "q":
        print("Fermeture du programme")
        exit(0)
    else:
        print("Je n'ai pas compris votre choix, veuillez sélectionner l'une des options.")
        icmp()

    proceed()

def proceed():
    while True:
        proceed = input("Voulez-vous continuer ? (Y/N): ")
        if proceed.lower() == "y":
            menu()
        elif proceed.lower() == "n":
            print("Fermeture du programme")
            exit(0)
        else:
            print("Je n'ai pas compris votre demande, veuillez sélectionner l'une des options.")

def menu():
    print("""
Que voulez-vous faire ?
> 1: ICMP
> 2: TCP Port Discovery
> 3: HTTP Port Discovery
> 4: UDP Port Discovery
> 5: SCTP Port Discovery
> 6: Discovering hosts
> Q: Quitter
    """)
    choix = input("Veuillez sélectionner une option: ")
    if choix == "1":
        icmp()
    elif choix == "2":
        tcpportdiscovery()
    elif choix == "3":
        httpportdiscovery()
    elif choix == "4":
        udpportdiscovery()
    elif choix == "5":
        sctpportdiscovery()
    elif choix == "6":
        discoveringhosts()
    elif choix.lower() == "q":
        print("Fermeture du programme")
        exit(0)
    else:
        print("Veuillez sélectionner une option présente dans la liste.")
        menu()

def main():
    global enterprise
    global target
    global cidr
    enterprise = input("Quel est le nom de l'entreprise que vous souhaitez auditer ? : ")
    target = input("Entrez l'adresse IP réseau de la cible : ")
    cidr = input("Veuillez saisir une plage (masque sous la forme cidr) : ")
    os.makedirs(enterprise, exist_ok=True)
    print(f"Le répertoire {enterprise} a été créé")
    menu()

if __name__ == '__main__':
    main()