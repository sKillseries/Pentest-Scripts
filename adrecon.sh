#!/bin/bash

cible=$1
mask=$2
range=$3

if [ ! -d "resultats" ];then
    mkdir resultats
fi
if [ ! -d "files_to_process" ];then
    mkdir files_to_process
fi
if [ ! -d "resultats/adrecon.md" ];then
    touch resultats/adrecon.md
fi

echo "[*] DHCP Checking..."
{
    echo -e "## DHCP Check result\n"
    echo '```'
    nmap --script broadcast-dhcp-discover
    echo -e '```\n'
} >> resultats/adrecon.md

nmap --script broadcast-dhcp-discover -oX files_to_process/ad_dhcp_nmap_scan.xml

echo "[*] DNS checking..."
{
    echo -e "## DNS Check result\n"
    echo '```'
    nmap --script dns-srv-enum --script-args dns-srv-enum.domain="$cible"
    echo -e '```\n'
} >> resultats/adrecon.md

nmap --script dns-srv-enum --script-args dns-srv-enum.domain="$cible" -oX files_to_process/ad_dns_check_nmap_scan.xml

echo "[*] Disvovering DNS nameservers..."
{
    echo -e "## DNS Discover result\n"
    echo '```'
    nmap -v -sV -p 53 "$cible"/"$mask"
    echo -e '```\n'
    echo '```'
    nmap -v -sV -sU -p 53 "$cible"/"$mask"
    echo -e '```\n'
} >> resultats/adrecon.md

nmap -v -sV -p 53 "$cible"/"$mask" -oX files_to_process/ad_dns_discover_nmap_scan1.xml
nmap -v -sV -sU -p 53 "$cible"/"$mask" -oX files_to_process/ad_dns_discover_nmap_scan2.xml

echo "[*] Reverse lookups PTR"
{
    echo -e "## PTR result\n"
    echo '```'
    dnsrecon -r "$range" -n "$cible"
    echo -e '```\n'
} >> resultats/adrecon.md

dnsrecon -r "$range" -n "$cible" 2>&1 | jq -R -s -c 'split("\n") | {results: .}' > files_to_process/ad_ptr_dnsrecon.json

echo "[*] nbt-ns scanning..."
{
    echo -e "## nbt scan result\n"
    echo '```'
    nbtscan -r "$cible"/"$mask"
    echo -e '```\n'
    echo '```'
    nmblookup -A "$cible"
    echo -e '```\n'
} >> resultats/adrecon.md

nbtscan -r "$cible"/"$mask" 2>&1 | jq -R -s -c 'split("\n") | {results: .}' > files_to_process/ad_nbt_nbtscan.json
nmblookup -A "$cible" 2>&1 | jq -R -s -c 'split("\n") | {results: .}' > files_to_process/ad_nbt_nmblookup.json

echo "[*] Port scanning..."
{
    echo -e "## Port Scan result\n"
    echo '```'
    nmap -sS -n --open -p 88,389 "$cible"
    echo -e '```\n'
} >> resultats/adrecon.md

nmap -sS -n --open -p 88,389 "$cible" -oX files_to_process/ad_port_nmap_scan.xml

echo "[*] ldap checking..."
{
    echo -e "## ldap check result\n"
    echo '```'
    impacket-ntlmrelayx -t "ldap://'$cible'" --dump-adcs --dump-laps --dump-gmsa
    echo -e '```\n'
    echo '```'
    windapsearch --dc "$cible" --module users
    echo -e '```\n'
    echo '```'
    windapsearch --dc "$cible" --module metadata
    echo -e '```\n'
} >> resultats/adrecon.md

impacket-ntlmrelayx -t "ldap://'$cible'" --dump-adcs --dump-laps --dump-gmsa 2>&1 | jq -R -s -c 'split("\n") | {results: .}' > files_to_process/ad_ldap_impacket.json
windapsearch --dc "$cible" --module users 2>&1 | jq -R -s -c 'split("\n") | {results: .}' > files_to_process/ad_ldap_windapsearch_users.json
windapsearch --dc "$cible" --module metadata 2>&1 | jq -R -s -c 'split("\n") | {results: .}' > files_to_process/ad_ldap_windapsearch_metadata.json

echo "[*] Looking for exposed rpc services..."
{
    echo -e "## exposed rpc services result\n"
    echo '```'
    impacket-rpcdump -port 135 "$cible"
    echo -e '```\n'
    echo '```'
    impacket-rpcdump -port 593 "$cible"
    echo -e '```\n'
} >> resultats/adrecon.md

impacket-rpcdump -port 135 "$cible" 2>&1 | jq -R -s -c 'split("\n") | {results: .}' > files_to_process/ad_impacket_rpcdump1.json
impacket-rpcdump -port 593 "$cible" 2>&1 | jq -R -s -c 'split("\n") | {results: .}' > files_to_process/ad_impacket_rpcdump2.json

echo "[*] enum4linux checking..."
{
    echo -e "## enum4linux result\n"
    echo '```'
    enum4linux -A "$cible"
    echo -e '```\n'
} >> resultats/adrecon.md

enum4linux -A "$cible" 2>&1 | jq -R -s -c 'split("\n") | {results: .}' > files_to_process/ad_enum4linux.json